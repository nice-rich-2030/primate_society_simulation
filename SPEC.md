# Primate Society Simulation - Specification (SPEC.md)

## 1.1 課題分析・機能提案

### 課題 (Issues)
「閉ざされた世界（村）」における3種類の霊長類の生態系や社会的相互作用を、頭の中だけでシミュレーションし、その均衡点や破綻のシナリオを予測することは困難である。
特に、各種類の特性（強さ、繁殖力、知能など）が異なる場合、どのようなパラメータで共存が可能か、あるいは一種が支配的になるかを検証する手段がない。

### 解決策 (Solution)
3種類の異なる特性を持つ霊長類エージェントが、閉鎖空間（村）で資源を争奪・共有しながら生存競争を行うシミュレーションS/Wを開発する。
これにより、ユーザーはパラメータ調整を通じて「三すくみ」や「共生」の条件を視覚的に観察・実験できる。

### 潜在的課題の提案
*   **遺伝的多様性の欠如**: 単純なパラメータ固定だとシミュレーションが単調になる可能性があるため、個体ごとの多少のランダム性（性格値）を導入する。
*   **環境の有限性**: 村という「閉ざされた」環境であるため、人口爆発による全滅を防ぐための「環境収容力（資源の枯渇）」の概念を導入する。

### 主要機能 (Key Functions)
1.  **シミュレーション実行機能**: リアルタイムでエージェントが自律行動（移動、食事、繁殖、戦闘）する。
2.  **可視化機能**: 2Dマップ上で各個体の位置、状態、種類を色やアイコンで識別表示する。
3.  **パラメータ調整機能**: 設定ファイルにより、各種類の初期ステータスや繁殖率を変更可能にする。
4.  **メンテナンス・デバッグ機能**: 内部ステートの可視化、ログ出力。

---

## 1.2 技術スタック選定・選定根拠

### 選定技術
*   **言語**: Python 3.10+
*   **ライブラリ**: Pygame (GUI/描画), NumPy (数値計算・データ処理)

### 選定理由
*   **Pygame**: 2Dエージェントシミュレーションにおいて、スプライト描画や座標管理が容易であり、軽量で動作が高速であるため。Webアプリよりもローカルでの計算資源を直接利用でき、大規模な個体数（数百体）の計算に適している。
*   **Python**: ユーザーがパラメータ調整やロジック改造を行う際、可読性が高く修正が容易であるため。

---

## 1.3 機能詳細化 (ブレイクダウン)

### A. 環境シミュレーション機能
*   **マップ生成**: 「村」の境界（壁）と内部の障害物（家、木）を生成する。
*   **資源生成**: 時間経過とともに食料（植物、肉など）がマップ上の特定のポイントにポップする。
*   **時間経過**: 1フレームを特定の時間単位とし、昼夜の概念や経年変化（寿命）を管理する。

### B. 霊長類エージェント行動機能
*   **移動・探索**: 視界内の資源や他個体を認識し、接近または回避する。
*   **生命維持**: 空腹度、体力、年齢のパラメータを持ち、枯渇すると死亡する。
*   **相互作用**:
    *   同種: 協力（グルーミングでストレス解消）、繁殖、**情報交換（学習）**。
    *   異種: 戦闘（強弱関係）、威嚇、無視。
    *   **学習 (Reinforcement Learning)**:
        *   各個体は、状況（食料探索、戦闘、逃走）ごとに「どの戦略を採用するか」の**確率分布 (Probability Distribution)** を持つ。
        *   例: 食料探索 = {Wide: 0.2, Fast: 0.5, Random: 0.3}
        *   **学習プロセス**:
            1.  他個体と接触時、相手の「適応度 (Fitness)」（HPや満腹度で算出）を比較する。
            2.  相手の方が適応度が高い場合、相手を「教師」とする。
            3.  相手の戦略確率分布に、自分の確率分布を少し近づける（Learning Rate $\alpha$ を用いた加重平均）。
            4.  数式: $P_{self} \leftarrow (1 - \alpha) P_{self} + \alpha P_{teacher}$
            5.  これにより、集団全体として生存に適した戦略の割合が増加していく。

### B2. 戦略と多角的なアプローチ (New)
*   **食料探索戦略**:
    *   **Wide View**: 視界を広げるが移動が遅い。
    *   **Fast Move**: 移動は速いが視界が狭い。
    *   **Random Walk**: ランダム性が高い。
    *   **Ambush**: 待ち伏せ型（移動極小）。
*   **戦闘戦略**:
    *   **Aggressive**: 先制攻撃重視。
    *   **Defensive**: カウンター狙い。
    *   **Group**: 近くの仲間と連携（評価値加算）。
*   **逃走戦略**:
    *   **Speed**: 直線的に最速で逃げる。
    *   **Hide**: 障害物の影に隠れる。
    *   **Scatter**: 予測不能な動きをする。
*   **空腹判断基準 (Hunger Threshold)**:
    *   「お腹がすいた」と判断して食料探索モードに移行する閾値を、個体ごとに持つ（例: 20%, 50%, 80%）。
    *   これも学習対象とし、生存率の高い個体の閾値に収束していく。
*   **戦略更新**:
    *   初期状態ではランダムに設定。
    *   一定時間ごとにランダムに再設定（突然変異的な要素）。
    *   他個体とのコミュニケーションによる学習（模倣）。

### C. 3種類の霊長類定義
1.  **ゴリラ型 (Gorilla)**:
    *   **特徴**: 体力・攻撃力が高い。移動は遅い。
    *   **食性**: 植物食。大量の食料を必要とする。
    *   **社会**: 小規模な群れを作る。防衛的。
2.  **チンパンジー型 (Chimp)**:
    *   **特徴**: 攻撃的、移動速度が速い。
    *   **食性**: 雑食（植物も肉も食べる、他種を狩ることもある）。
    *   **社会**: 集団で狩りをする。好戦的。
3.  **ボノボ/オランウータン型 (Bonobo)**:
    *   **特徴**: 平和的、高い繁殖力or高い知能（道具使用など、今回は「回避能力」や「食料発見率」で表現）。
    *   **食性**: 植物食。
    *   **社会**: 高頻度の社会行動（HP回復が早い）。

### D. UI/UX・表示機能
*   **メインビュー**: エージェントとマップの俯瞰表示。
*   **ステータスパネル**: 全体の個体数推移グラフ、選択した個体の詳細パラメータ表示。
*   **個体表示**: 採用している戦略（特に探索戦略）に応じて、エージェントの色や装飾（枠色など）を変化させ、多様性を可視化する。
*   **操作**: 一時停止、倍速再生、リセット。

---

## 1.4 データモデル・データ構造定義

### クラス構造
*   `Agent` (Base Class):
    *   `id`, `position`(x,y), `species_id`, `hp`, `energy`, `age`, `state`
    *   **Strategies**: `foraging_strategy`, `combat_strategy`, `flee_strategy`
    *   **Parameters**: `hunger_threshold` (探索開始閾値)
    *   Methods: `update()`, `move()`, `perceive()`, `act()`, `learn(other_agent)`

*   `SpeciesConfig`: 各種類のデフォルトパラメータ（移動速度、視界範囲、攻撃力、寿命）。
*   `Map`:
    *   `width`, `height`
    *   `resources`: List of `Resource` objects.
    *   `obstacles`: List of Rects.
*   `Resource`: `type` (Plant/Meat), `amount`, `position`.

---

## 1.5 ユーザー操作シナリオ

1.  **設定 (Pre-launch)**: ユーザーは `config.py` を開き、3種類の初期個体数やマップサイズを調整する（任意）。
2.  **起動 (Launch)**: `main.py` を実行する。
3.  **観察 (Observe)**: ウィンドウが開き、村の中に3種類のドット（エージェント）が動き回る様子を見る。
    *   最初は平和だが、個体数が増えると食料不足になり、争いが始まる様子を観察する。
    *   画面端のグラフで、どの種が優勢かを確認する。
4.  **詳細確認 (Inspect)**: 特定の個体をクリックし、「現在の行動：狩り」「HP: 50/100」などの詳細を見る。
5.  **終了 (Exit)**: ウィンドウを閉じる。

---

## 1.6 ユーザーインターフェース (UI) 分析

### 画面レイアウト
*   **左側 (70%)**: シミュレーションフィールド（村）。
    *   背景: 土色や草色。
    *   エージェント: 丸形アイコン（赤＝ゴリラ、青＝チンパンジー、緑＝ボノボ）。
    *   資源: 小さなアイコン（木の実、肉）。
*   **右側 (30%)**: 情報パネル。
    *   **Total Population**: 各種の現在の数。
    *   **Selected Agent**: クリックしたエージェントの情報。
    *   **Log**: 直近のイベント（"ID:5 died of hunger", "Species A attacked Species B"）。

### エラーハンドリング
*   設定ファイルの記述ミス等は、コンソールに分かりやすいエラーメッセージを表示して起動前に通知する。

---

## 1.7 フォルダ・ファイル構成 (アーキテクチャ)

```text
d:/primate_society_simulation/
│
├── main.py            # エントリーポイント。初期化とメインループ。
├── config.py          # パラメータ設定（種族ごとのステータス等）。
├── entities.py        # Agentクラス, Species定義。 (約500行)
├── environment.py     # Map, Resource管理。 (約300行)
├── ui.py              # 描画関連、UIウィジェット。 (約400行)
├── utils.py           # 幾何計算、ユーティリティ関数。
└── SPEC.md            # 本仕様書。
```

---

## 1.8 実装概要

*   **main.py**: Pygameの初期化、各マネージャーのインスタンス化、フレームレート固定ループ。
*   **entities.py**: ステートマシン（Finite State Machine）を実装し、エージェントのAI（お腹が空いたら食料を探す、敵がいたら逃げる/戦う）を記述。
*   **environment.py**: グリッドまたは連続空間での衝突判定、資源のスポーンロジック。
*   **ui.py**: PygameのSurface操作、テキスト描画、グラフ描画ロジック。

## 1.9 メンテナンス・デバッグ機能・セキュリティ

*   **ログ出力**: `logging` モジュールを使用し、シミュレーションの重要な節目（生誕、死亡、絶滅）をログファイルに出力。AIによる事後解析を容易にする。
*   **デバッグ表示**: キーボードショートカット（例: 'D'キー）で、エージェントの視界範囲（円）や現在目指しているターゲットへのラインを描画するモードを実装。
