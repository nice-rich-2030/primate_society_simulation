# Primate Society Simulation

3種類の霊長類（ゴリラ、チンパンジー、ボノボ）が閉鎖された村で資源を争いながら生存競争を行うシミュレーションです。各個体は強化学習的な仕組みで戦略を学習し、適応していきます。

## 特徴

- **3種の霊長類**: それぞれ異なる特性を持つ（体力、速度、食性など）
- **戦略パターン**: 食料探索の4つの戦略（Wide View, Fast Move, Random Walk, Ambush）
- **強化学習**: 個体同士が互いに学習し、適応度の高い個体の戦略を模倣
- **リアルタイム可視化**: 各個体の位置、種類、使用中の戦略を色分けして表示

## インストール

### 依存関係のインストール

```bash
pip install -r requirements.txt
```

必要なパッケージ:
- pygame >= 2.5.0
- numpy >= 1.24.0

## 実行方法

```bash
python main.py
```

## 操作方法

- **SPACE**: 一時停止/再開
- **ESC**: 終了
- **マウスクリック**: 個体を選択して詳細情報を表示

## シミュレーション画面の見方

### 左側: シミュレーションフィールド
- **🦍 ゴリラ**: 高HP、遅い、植物食（赤枠・アイコンで表示）
- **🐵 チンパンジー**: 中HP、速い、雑食（青枠・アイコンで表示）
- **🐒 ボノボ**: 低HP、中速、植物食（緑枠・アイコンで表示）
- **🌿 植物**: 植物性の食料
- **🍖 肉**: 動物性の食料（チンパンジーのみ食べられる）
- **枠の色**: 現在使用中の食料探索戦略を示す
  - 黄色: Wide View（広視野、遅い）
  - オレンジ: Fast Move（速い移動、狭視野）
  - 紫: Random Walk（ランダム）
  - 灰色: Ambush（待ち伏せ）
- **白い枠**: 選択された個体

### 右側: 情報パネル
- **Population**: 各種の個体数
- **Strategies**: 戦略の色の凡例
- **Statistics**: 種族ごとの統計情報
  - 平均HP、総HP、平均エネルギー
  - 最も多く使われている戦略
- **Controls**: 操作方法

### 選択ポップアップ（左上）
個体をクリックすると表示される詳細情報：
- 基本ステータス（HP、エネルギー、年齢、位置）
- 空腹閾値（この値以下になると食料探索開始）
- 全戦略の確率分布（>マークが現在使用中の戦略）
- 適応度スコア

## 仕組み

### 処理フロー

```
Agent.update()
    ├─ 年齢・代謝処理
    │   ├─ 年齢を加算
    │   ├─ エネルギーを減少（代謝）
    │   └─ エネルギー20%以下でHPにダメージ（飢餓）
    │
    ├─ 死亡判定
    │   └─ HP≤0 or エネルギー≤0 or 寿命 → state='dead'
    │
    └─ 状態機械（優先順位順）
        ├─ Priority 1: HP < 30% → fleeing
        │   └─ execute_fleeing()
        │       ├─ 脅威検出範囲で最も近い敵を探す
        │       ├─ pick_strategy('flee') で逃走戦略を選択
        │       ├─ 選択された戦略を実行（Speed/Hide/Scatter）
        │       └─ 安全距離（view_range × 2.0）に達したら脅威解除
        │
        ├─ Priority 2: should_fight() → fighting
        │   ├─ 条件: エネルギー≥40% かつ view_range以内に敵 かつ 適応度が敵の120%以上
        │   └─ execute_combat()
        │       ├─ pick_strategy('combat') で戦闘戦略を選択
        │       └─ 選択された戦略を実行（Aggressive/Defensive/Group）
        │
        ├─ Priority 3: エネルギー < hunger_threshold → foraging
        │   └─ execute_foraging()
        │       ├─ 10%の確率でpick_strategy('foraging')を再選択
        │       ├─ 現在の戦略を実行（WideView/FastMove/RandomWalk/Ambush）
        │       └─ eat() で近くの食料を消費
        │
        └─ Priority 4: idle
            └─ wander() でランダムに徘徊
```

### 状態機械
各個体は以下の状態を持ちます（優先順位順）：
1. **fleeing**: 逃走中（HP 30%以下）
2. **fighting**: 戦闘中（十分なエネルギーがあり、弱い敵が近くにいる）
3. **foraging**: 食料探索中（エネルギーが空腹閾値以下）
4. **idle**: 待機中（エネルギー十分）

### 食料探索（Foraging）

**発生条件**:
- エネルギーが`hunger_threshold`（個体ごとにランダム20-80%）以下になると開始

**戦略選択**:
- 各フレーム10%の確率で戦略を再選択（確率分布に基づく）
- 残り90%は現在の戦略を継続使用

**食料探索戦略**:
- **WideView（広視野）**: 広い視野で食料を探す、移動速度0.8倍
- **FastMove（高速移動）**: 狭い視野だが速く移動、移動速度1.5倍
- **RandomWalk（ランダム）**: ランダムに動き回る
- **Ambush（待ち伏せ）**: 動かずに待機、エネルギー消費少

#### 戦闘システム
**発生条件**:
- エネルギーが40%以上
- 近くに他種族がいる（`view_range × 1.0`以内）
  - ゴリラ: 80px
  - チンパンジー: 120px
  - ボノボ: 100px
- 自分の適応度が相手の120%以上

**戦略選択**:
- 戦闘状態に入るたびに`pick_strategy('combat')`で確率分布に基づいて選択

**戦闘戦略**:
- **Aggressive（攻撃的）**: 高ダメージ（攻撃力150%）、高リスク（反撃50%）、高エネルギー消費
- **Defensive（防御的）**: カウンター攻撃（攻撃力80% + 防御力）、低リスク（反撃20%）、中エネルギー消費
- **Group（集団戦）**: 仲間と協力（仲間1人につき+30%ダメージ）、分散ダメージ（反撃30%）、エネルギー分担

#### 逃走システム
**発生条件**:
- HPが30%以下になると自動的に逃走状態に移行（全種族共通）
- 距離や検出範囲は関係なく、HP閾値のみで判定

**戦略選択**:
- 逃走状態に入るたびに`pick_strategy('flee')`で確率分布に基づいて選択

**逃走開始後の脅威検出**:
逃走状態に入った後、どの敵から逃げるかを決定するために周囲をスキャンします。

- **脅威検出範囲**（種族ごとに異なる）:
  - 基本検出範囲: `view_range × 1.5`
    - ゴリラ: 120px（view_range 80 × 1.5）
    - チンパンジー: 180px（view_range 120 × 1.5）
    - ボノボ: 150px（view_range 100 × 1.5）
  - **Ambush戦略使用時**: さらに1.3倍（待ち伏せ中の警戒心向上）
    - ゴリラ: 156px
    - チンパンジー: 234px
    - ボノボ: 195px
  - この範囲内にいる他種族の中から最も近い敵を脅威対象として設定

**安全距離**（逃走終了判定）:
- `view_range × 2.0`で脅威から離れると安全と判定し、逃走状態を解除
  - ゴリラ: 160px
  - チンパンジー: 240px
  - ボノボ: 200px

**逃走戦略**:
- **Speed（全速逃走）**: 最速（通常の2倍速）、直線的、高エネルギー消費
- **Hide（隠れる）**: 障害物の裏に隠れる、低エネルギー消費、発見されにくい
- **Scatter（ジグザグ逃走）**: ランダムな方向転換、予測困難、中エネルギー消費

### 戦略確率分布と学習メカニズム

#### 確率分布の構造

各個体は、行動コンテキストごとに独立した**戦略確率分布**を保持しています。

**3つのコンテキスト**:
1. **食料探索（Foraging）**: 4つの戦略（WideView, FastMove, RandomWalk, Ambush）
2. **戦闘（Combat）**: 3つの戦略（Aggressive, Defensive, Group）
3. **逃走（Flee）**: 3つの戦略（Speed, Hide, Scatter）

**確率分布の特性**:
- 各コンテキスト内の全戦略の確率合計は必ず1.0（100%）
- 初期値はランダムに設定（個体ごとに異なる）
- 学習によって時間とともに変化

**初期化の例**:
```
ゴリラ#0の初期確率分布:
  食料探索: {WideView: 0.25, FastMove: 0.31, RandomWalk: 0.07, Ambush: 0.37}
  戦闘:     {Aggressive: 0.18, Defensive: 0.52, Group: 0.30}
  逃走:     {Speed: 0.45, Hide: 0.22, Scatter: 0.33}

ゴリラ#1の初期確率分布:
  食料探索: {WideView: 0.13, FastMove: 0.29, RandomWalk: 0.41, Ambush: 0.17}
  戦闘:     {Aggressive: 0.44, Defensive: 0.31, Group: 0.25}
  逃走:     {Speed: 0.28, Hide: 0.48, Scatter: 0.24}
```

#### 戦略選択メカニズム

行動実行時、現在のコンテキストに応じて確率分布から戦略を選択します。

**選択方法**:
- 重み付きランダム選択（`random.choices()`）
- 確率が高い戦略ほど選ばれやすい
- 完全に決定的ではなく、毎回ランダム性がある

**タイミング**:
- **食料探索**: 10%の確率で毎フレーム再選択、90%は継続使用
- **戦闘**: 5%の確率で毎フレーム再選択、95%は継続使用
- **逃走**: 5%の確率で毎フレーム再選択、95%は継続使用

#### 学習メカニズム

1. 個体は近くの他個体と接触すると、相手の「適応度」を比較
2. 適応度 = (HP率 + エネルギー率) で計算
3. 相手の方が適応度が高い場合、相手の戦略確率分布を学習
4. 学習式: `P_self ← (1 - α) * P_self + α * P_teacher`（α = 0.1）

### 代謝と生存
- 毎フレーム、エネルギーが減少（代謝）
- エネルギーが一定値以下になると食料探索を開始
- 食料を食べるとエネルギーとHPが回復
- エネルギー0、HP0、または寿命で死亡

## 設定のカスタマイズ

[config.py](config.py) で以下のパラメータを調整可能：

- `INITIAL_GORILLA_COUNT`, `INITIAL_CHIMP_COUNT`, `INITIAL_BONOBO_COUNT`: 初期個体数
- `LEARNING_RATE`: 学習率（0.1 = 10%ずつ学習）
- `METABOLISM_RATE`: 代謝率（エネルギー消費速度）
- `RESOURCE_SPAWN_INTERVAL`: 資源生成間隔
- `SPECIES_CONFIG`: 各種の詳細パラメータ（HP、速度、攻撃力など）

### 画像アセットについて
`assets/` ディレクトリ内のPNG画像（ゴリラ、チンパンジー、ボノボ、植物、肉）を使用して描画を行います。
各画像はピクセルアートスタイルで作成されています。

## ファイル構成

```
primate_society_simulation/
├── main.py              # エントリーポイント、メインループ
├── config.py            # 設定定数
├── entities.py          # エージェント、戦略パターン (~450行)
├── environment.py       # 環境、資源管理
├── ui.py                # UI、描画
├── utils.py             # ユーティリティ関数
├── test_verify.py       # 検証テスト
├── requirements.txt     # 依存パッケージ
├── assets/              # 画像アセット（PNG）
├── SPEC.md              # 詳細仕様書
├── TODO.md              # 実装計画
└── README.md            # 本ファイル
```

## テスト

動作確認用のテストを実行：

```bash
python test_verify.py
```

## 今後の拡張可能性

- 繁殖機能の実装
- 戦闘システムの実装
- 集団行動（群れ）の実装
- より複雑な環境（季節、天候）
- データログとグラフ分析
- パラメータ調整UI

## ライセンス

このプロジェクトは教育・研究目的で作成されました。

## 技術詳細

詳細な仕様は [SPEC.md](SPEC.md) を参照してください。
